# ============================================================
# ğŸ“˜ recommend_app.py (LightGBM ê¸°ë°˜ ìµœì¢… ì™„ì„±í˜•)
# Flask + LightGBM Multi-label ì·¨ë¯¸ ì¶”ì²œ API
# - KNN ì™„ì „ ì œê±°
# - 45ê°œ ì·¨ë¯¸ MultiLabel í™•ë¥  ê¸°ë°˜ ì¶”ì²œ
# - React ì„¤ë¬¸ ì •ê·œí™” ë§¤í•‘ ìœ ì§€
# - ì…ë ¥ ê²€ì¦ ë° ì˜ˆì™¸ ì²˜ë¦¬ ê°•í™”
# ============================================================

from flask import Flask, request, jsonify
from flask_cors import CORS
import pandas as pd
import numpy as np
import re
from sklearn.preprocessing import MultiLabelBinarizer
from sklearn.model_selection import train_test_split
import lightgbm as lgb

# ------------------------------------------------------------
# 1ï¸âƒ£ Flask ì„¤ì •
# ------------------------------------------------------------
app = Flask(__name__)
CORS(app)

# ------------------------------------------------------------
# 2ï¸âƒ£ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
# ------------------------------------------------------------
EXCEL_PATH = "ì·¨ë¯¸ ì„¤ë¬¸ì¡°ì‚¬.xlsx"
print(f"ğŸ“‚ ë°ì´í„° ë¡œë“œ ì¤‘... ({EXCEL_PATH})")
df = pd.read_excel(EXCEL_PATH)

df = df.rename(columns={
    "ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”(*)": "gender",
    "ì—°ë ¹ëŒ€ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”(*)": "age_group",
    "ì·¨ë¯¸ í™œë™ì„ ì„ í˜¸í•˜ëŠ” ì¥ì†ŒëŠ” ì–´ë””ì¸ê°€ìš”?(*)": "preferred_place",
    "ì·¨ë¯¸ í™œë™ ì„±í–¥ì€ ì–´ë–¤ í¸ì¸ê°€ìš”?(*)": "propensity",
    "ì·¨ë¯¸ í™œë™ì— ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì›” ì˜ˆì‚°ì€ ì–´ëŠ ì •ë„ì¸ê°€ìš”?(*)": "budget",
    "í˜„ì¬ ì¦ê¸°ê³  ìˆëŠ” ì·¨ë¯¸ëŠ” ë¬´ì—‡ì¸ê°€ìš”?(*)": "current_hobbies",
    "í˜„ì¬ ì–´ë–¤ ì·¨ë¯¸ í™œë™ì— ê´€ì‹¬ì´ ìˆë‚˜ìš”?(*)": "interest_hobbies",
    "ì·¨ë¯¸ë¥¼ ì¦ê¸°ê³  ì‹¶ì€ ì‹œê°„ëŒ€ëŠ” ì–¸ì œì¸ê°€ìš”?(*)": "hobby_time",
    "í•˜ë£¨ì— ì·¨ë¯¸ í™œë™ì— íˆ¬ìí•  ìˆ˜ ìˆëŠ” ì‹œê°„ì€ ì–¼ë§ˆë‚˜ ë˜ë‚˜ìš”?(*)": "time_per_day",
    "ì·¨ë¯¸ í™œë™ ì£¼ê¸°ë¥¼ ì–´ëŠ ì •ë„ë¡œ í•˜ê³  ì‹¶ë‚˜ìš”?(*)": "frequency",
    "ì·¨ë¯¸ í™œë™ì„ í†µí•´ ì–»ê³  ì‹¶ì€ ê²ƒì€ ë¬´ì—‡ì¸ê°€ìš”?(*)": "goal",
    "í˜¼ì í•˜ëŠ” ì·¨ë¯¸ í™œë™ì„ ì„ í˜¸í•˜ì‹œë‚˜ìš”, í•¨ê»˜ í•˜ëŠ” ì·¨ë¯¸ í™œë™ì„ ì„ í˜¸í•˜ì‹œë‚˜ìš”?(*)": "sociality"
})

FEATURE_COLUMNS = [
    "gender", "age_group", "preferred_place", "propensity", "budget",
    "hobby_time", "time_per_day", "frequency", "goal", "sociality"
]

# ------------------------------------------------------------
# 3ï¸âƒ£ ì „ì²˜ë¦¬ í•¨ìˆ˜
# ------------------------------------------------------------
def split_multi(cell):
    if pd.isna(cell):
        return []
    parts = re.split(r'\s*\|\s*|\s*,\s*|\s*\/\s*|\s*;\s*|\n', str(cell))
    return [p.strip() for p in parts if p.strip()]

def normalize_hobby(hobby):
    hobby = hobby.strip().lower()
    mapping = {
        "í—¬ìŠ¤": ["ìš´ë™", "í”¼íŠ¸ë‹ˆìŠ¤", "í—¬ìŠ¤ì¥", "í—¬ìŠ¤"],
        "ëŸ¬ë‹": ["ë‹¬ë¦¬ê¸°", "ì¡°ê¹…", "ëŸ¬ë‹"],
        "ê·¸ë¦¼ ê·¸ë¦¬ê¸°": ["ê·¸ë¦¼", "ìˆ˜ì±„í™”ê·¸ë¦¬ê¸°", "ì»¬ëŸ¬ë§ë¶í•˜ê¸°", "ê·¸ë¦¼ê·¸ë¦¬ê¸°"],
        "ì—¬í–‰": ["ì‚°ì±…", "ìº í•‘", "ì°¨ë°•", "ì—¬í–‰"],
        "ë…ì„œ": ["ì±…ì½ê¸°", "ë…ì„œ"],
        "ìš”ë¦¬": ["ë² ì´í‚¹", "ìš”ë¦¬"],
        "ê²Œì„": ["ê²Œì„", "pcê²Œì„"],
        "ì¶•êµ¬ ê´€ëŒ": ["ì¶•êµ¬ë³´ê¸°", "ì¶•êµ¬ ê´€ëŒ"],
        "ì•¼êµ¬ ê´€ëŒ": ["ì•¼êµ¬ë³´ê¸°", "ì•¼êµ¬ ê´€ëŒ","ì•¼êµ¬ ì§ê´€"],
        "ìŒì•… ê°ìƒ": ["ìŒì•… ê°ìƒ ë° ì°¾ê¸°"],
        "OTT ê°ìƒ" : ["ott ê°ìƒ"]

    }
    for key, synonyms in mapping.items():
        if hobby in synonyms:
            return key
    return hobby

df["interest_hobbies_list"] = (
    df["interest_hobbies"]
    .apply(split_multi)
    .apply(lambda lst: [normalize_hobby(h) for h in lst])
)

# ------------------------------------------------------------
# 4ï¸âƒ£ MultiLabelBinarizerë¡œ ì·¨ë¯¸ ë©€í‹°ë¼ë²¨ ë³€í™˜
# ------------------------------------------------------------
mlb = MultiLabelBinarizer()
y_multi = mlb.fit_transform(df["interest_hobbies_list"])

HOBBY_LABELS = list(mlb.classes_)

# ------------------------------------------------------------
# 5ï¸âƒ£ ë²”ì£¼í˜• íŠ¹ì§• ì¸ì½”ë”©
# ------------------------------------------------------------
df_encoded = pd.get_dummies(df[FEATURE_COLUMNS], dummy_na=False)
X = df_encoded.values

# ------------------------------------------------------------
# 6ï¸âƒ£ LightGBM ë©€í‹°ë¼ë²¨ ëª¨ë¸ í•™ìŠµ
# ------------------------------------------------------------
print("ğŸš€ LightGBM ëª¨ë¸ í•™ìŠµ ì¤‘... (45ê°œ ì·¨ë¯¸ í™•ë¥  ì˜ˆì¸¡)")

lgb_models = {}
params = {
    "objective": "binary",
    "learning_rate": 0.06,
    "metric": "binary_logloss",
    "num_leaves": 31,
    "verbose": -1
}

for idx, hobby in enumerate(HOBBY_LABELS):
    y_label = y_multi[:, idx]
    train_data = lgb.Dataset(X, label=y_label)

    model = lgb.train(params, train_data, num_boost_round=150)
    lgb_models[hobby] = model

print("âœ… LightGBM Multi-label ëª¨ë¸ í•™ìŠµ ì™„ë£Œ!")

# ------------------------------------------------------------
# 7ï¸âƒ£ React ì„¤ë¬¸ â†’ ì •ê·œí™” ë§¤í•‘
# ------------------------------------------------------------
def normalize_input_value(key, value):
    mapping = {
        "age_group": {
            "10ëŒ€": "10ëŒ€", "20ëŒ€ ì´ˆÂ·ì¤‘ë°˜": "20ëŒ€", "20ëŒ€ í›„ë°˜": "20ëŒ€",
            "30ëŒ€": "30ëŒ€", "40Â·50ëŒ€ ì´ìƒ": "40ëŒ€ ì´ìƒ",
        },
        "preferred_place": {
            "ì‹¤ë‚´": "ì‹¤ë‚´ì—ì„œ ì¡°ìš©íˆ í•˜ëŠ” ê±¸ ì¢‹ì•„í•´ìš”",
            "ì‹¤ì™¸": "ë°–ì—ì„œ í•˜ëŠ” ê±¸ ì¢‹ì•„í•´ìš”",
            "ìƒê´€ì—†ìŒ": "ì¥ì†Œì— í¬ê²Œ êµ¬ì• ë°›ì§€ ì•Šì•„ìš”",
        },
        "propensity": {
            "ì°½ì˜ì ": "ì°½ì˜ì ì´ê³  ê°ì„±ì ì¸ í¸ì´ì—ìš”",
            "í™œë™ì ": "í™œë™ì ì¸ í¸ì´ì—ìš”",
            "ì •ì ì¸": "ì¡°ìš©í•˜ê³  ì°¨ë¶„í•œ í¸ì´ì—ìš”",
            "ì‚¬êµì ì¸": "ìƒí™©ì— ë”°ë¼ ë‹¬ë¼ìš”",
        },
        "time_per_day": {
            "30ë¶„": "30ë¶„ ì´í•˜", "1ì‹œê°„": "1ì‹œê°„ ì´í•˜",
            "2ì‹œê°„": "1~2ì‹œê°„", "3ì‹œê°„ ì´ìƒ": "2ì‹œê°„ ì´ìƒ",
            "ìƒê´€ì—†ìŒ": "1ì‹œê°„ ì´í•˜",
        },
        "frequency": {
            "ë§¤ì¼": "ë§¤ì¼", "ì£¼ 2~3íšŒ": "ì£¼ 3íšŒ ì´í•˜",
            "ì£¼ 1íšŒ": "ì£¼ 3íšŒ ì´í•˜", "ì›” 2~3íšŒ": "ë¶ˆê·œì¹™í•˜ê²Œ í•˜ê³  ì‹¶ì–´ìš”",
            "ê°€ë”": "ë¶ˆê·œì¹™í•˜ê²Œ í•˜ê³  ì‹¶ì–´ìš”",
        },
        "hobby_time": {
            "ìƒˆë²½": "ì˜¤ì „", "ì˜¤ì „": "ì˜¤ì „", "ì˜¤í›„": "ì˜¤í›„", "ì €ë…": "ì €ë…",
            "ìƒê´€ì—†ìŒ": "ì£¼ë§ ì¤‘ì‹¬",
        },
        "budget": {
            "ë¬´ì˜ˆì‚° (0ì›)": "5ë§Œì› ì´í•˜",
            "ì €ì˜ˆì‚° (~5ë§Œì›)": "5ë§Œì› ì´í•˜",
            "ì¤‘ê°„ (5~15ë§Œì›)": "5ë§Œì› ~ 10ë§Œì›",
            "ê³ ì˜ˆì‚° (15ë§Œì›~)": "10ë§Œì› ì´ìƒ",
            "ìƒê´€ì—†ìŒ": "5ë§Œì› ì´í•˜",
        },
        "goal": {
            "ìŠ¤íŠ¸ë ˆìŠ¤ í•´ì†Œ": "ìŠ¤íŠ¸ë ˆìŠ¤ í•´ì†Œ ë° íë§",
            "ìê¸°ê³„ë°œ": "ìê¸°ê³„ë°œ",
            "ì‚¬íšŒì  êµë¥˜": "ì‚¬ëŒë“¤ê³¼ì˜ êµë¥˜",
            "ê±´ê°•ê´€ë¦¬": "ì„±ì·¨ê°ê³¼ ë§Œì¡±ê°",
        },
        "sociality": {
            "í˜¼ì": "í˜¼ì í•˜ëŠ” ê±¸ ì„ í˜¸í•´ìš”",
            "í•¨ê»˜": "í•¨ê»˜ í•˜ëŠ” ê±¸ ì„ í˜¸í•´ìš”",
            "ìƒê´€ì—†ìŒ": "ìƒí™©ì— ë”°ë¼ ë‹¬ë¼ìš”",
        },
    }
    return mapping.get(key, {}).get(value, value)

# ------------------------------------------------------------
# 8ï¸âƒ£ Hobby ID ë§¤í•‘
# ------------------------------------------------------------
hobby_id_map = {
    1: "ê·¸ë¦¼ ê·¸ë¦¬ê¸°", 2: "ìº˜ë¦¬ê·¸ë˜í”¼", 3: "ì‚¬ì§„ ì´¬ì˜", 4: "ê¸°íƒ€ ì—°ì£¼", 5: "í”¼ì•„ë…¸ ì—°ì£¼",
    6: "ìš”ê°€", 7: "í•„ë¼í…ŒìŠ¤", 8: "í—¬ìŠ¤", 9: "ëŸ¬ë‹", 10: "ìˆ˜ì˜", 11: "í•˜ì´í‚¹", 12: "ìì „ê±° íƒ€ê¸°",
    13: "ì°¨ë°•", 14: "ì—¬í–‰", 15: "ê³¨í”„", 16: "ë³µì‹±", 17: "ìš”ë¦¬", 18: "ë² ì´í‚¹", 19: "ì»¤í”¼ ë¸Œë£¨ì‰",
    20: "ë…ì„œ", 21: "ì–¸ì–´ ê³µë¶€", 22: "ëœ¨ê°œì§ˆ", 23: "ë³´ì„ì‹­ììˆ˜", 24: "í¼ì¦ ë§ì¶”ê¸°", 25: "ê²Œì„",
    26: "OTT ê°ìƒ", 27: "ì˜í™” ë³´ê¸°", 28: "ìŒì•… ê°ìƒ", 29: "ì—°ê·¹ ê´€ëŒ", 30: "ì½˜ì„œíŠ¸ ê´€ëŒ",
    31: "ì•¼êµ¬ ê´€ëŒ", 32: "ì¶•êµ¬ ê´€ëŒ", 33: "í’‹ì‚´", 34: "ë°°ë“œë¯¼í„´", 35: "í´ë¼ì´ë°",
    36: "ìš”ë¦¬ í´ë˜ìŠ¤", 37: "ë””ìì¸", 38: "ì•…ê¸° ì—°ì£¼", 39: "ìº í•‘", 40: "ë“±ì‚°",
    41: "í™ˆíŠ¸ë ˆì´ë‹", 42: "ìê¸°ê³„ë°œ", 43: "ë“œë¡œì‰", 44: "ì„œì˜ˆ", 45: "ì—°ì£¼íšŒ ê°ìƒ"
}

name_to_id = {v: k for k, v in hobby_id_map.items()}

# ------------------------------------------------------------
# ğŸ”¥ 9ï¸âƒ£ LightGBM ì¶”ì²œ í•¨ìˆ˜
# ------------------------------------------------------------
def recommend_hobbies_lgbm(user_answers, top_n=5):
    # 1) ì…ë ¥ê°’ ì¸ì½”ë”©
    user_df = pd.DataFrame([user_answers])
    user_encoded = pd.get_dummies(user_df).reindex(columns=df_encoded.columns, fill_value=0)
    X_new = user_encoded.values

    # 2) ì·¨ë¯¸ë³„ í™•ë¥  ê³„ì‚°
    hobby_probs = {}
    for hobby in HOBBY_LABELS:
        prob = lgb_models[hobby].predict(X_new)[0]
        hobby_probs[hobby] = round(float(prob), 4)

    # 3) í™•ë¥  ìƒìœ„ Nê°œ ì¶”ì¶œ
    sorted_hobbies = sorted(hobby_probs.items(), key=lambda x: x[1], reverse=True)
    top_hobbies = sorted_hobbies[:top_n]

    return top_hobbies

# ------------------------------------------------------------
# ğŸ”Ÿ API Routing
# ------------------------------------------------------------
@app.route("/")
def home():
    return "ğŸ¯ LightGBM ê¸°ë°˜ ì·¨ë¯¸ ì¶”ì²œ API ì‘ë™ ì¤‘!"

@app.route("/recommend", methods=["POST"])
def recommend():
    try:
        user_data = request.get_json()
        print("ğŸ“¥ ì…ë ¥ê°’:", user_data)

        if not user_data:
            return jsonify({"recommended_ids": [], "recommended_hobbies": []})

        normalized = {k: normalize_input_value(k, v) for k, v in user_data.items()}
        recs = recommend_hobbies_lgbm(normalized, top_n=5)

        hobby_names = [h[0] for h in recs]
        hobby_ids = [name_to_id.get(h) for h in hobby_names]

        print("ğŸ¯ ìµœì¢… ì¶”ì²œ:", hobby_names)

        return jsonify({
            "recommended_ids": hobby_ids,
            "recommended_hobbies": hobby_names
        })

    except Exception as e:
        print("âŒ ì˜¤ë¥˜:", e)
        return jsonify({"error": str(e)}), 500

# ------------------------------------------------------------
# ğŸš€ ì„œë²„ ì‹¤í–‰
# ------------------------------------------------------------
if __name__ == "__main__":
    print("ğŸš€ Flask + LightGBM ì·¨ë¯¸ ì¶”ì²œ ì„œë²„ ì‹œì‘!")
    app.run(host="0.0.0.0", port=5000)
